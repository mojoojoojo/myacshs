<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>myACSHS ‚Äî Official Portal (Cloud)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    /* Logo Colors: Red/Orange Gradient, Green Laurels, Gold Inner */
    --bg-1: #fff7ed; 
    --bg-2: #fffbeb; 
    
    --primary: #ea580c; 
    --primary-hover: #c2410c;
    --secondary: #16a34a; 
    --gold: #facc15; 
    
    --muted: #64748b; 
    --text: #1e293b;
    --card: #ffffff;
    
    --danger: #ef4444; 
    --success: #16a34a; 
    --warning: #f59e0b;
    
    --radius: 12px;
    --shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.1), 0 2px 4px -1px rgba(234, 88, 12, 0.06);
    --header-grad: linear-gradient(135deg, #dc2626 0%, #ea580c 50%, #ca8a04 100%);
  }

  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; font-family: 'Inter', sans-serif;
    background: var(--bg-1); color: var(--text);
    padding: 15px; display: flex; justify-content: center; min-height: 100vh;
    overflow-x: hidden;
  }

  .app { width: 100%; max-width: 1200px; display: flex; gap: 20px; flex-direction: column; }
  
  /* Colorful Header */
  header.app-header { 
    display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; 
    background: var(--header-grad);
    padding: 15px 20px;
    border-radius: var(--radius);
    color: white;
    box-shadow: 0 10px 15px -3px rgba(234, 88, 12, 0.3);
  }
  .brand { display: flex; gap: 12px; align-items: center; }
  .logo { 
    /* INCREASED SIZE AS REQUESTED */
    width: 60px; height: 60px; border-radius: 50%; 
    background: white; color: var(--primary); 
    display: flex; align-items: center; justify-content: center; 
    font-weight: 800; font-size: 18px; 
    border: 3px solid var(--gold);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    overflow: hidden; /* Ensures image stays in circle */
  }
  .title { font-weight: 800; font-size: 20px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); } 
  .subtitle-head { color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; }
  .subtitle { color: var(--muted); font-size: 13px; }

  .card { 
    background: var(--card); border-radius: var(--radius); padding: 20px; 
    box-shadow: var(--shadow); border: 1px solid #fed7aa; width: 100%;
  }
  
  .center-view { display: flex; align-items: center; justify-content: center; min-height: 70vh; flex-direction: column; width: 100%; }

  /* Forms */
  label { display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
  input, select, textarea { 
    width: 100%; padding: 11px 12px; border-radius: 8px; border: 2px solid #fed7aa; 
    font-size: 14px; background: #fff; transition: border-color 0.2s;
  }
  input:focus, select:focus { border-color: var(--primary); }

  /* Radio/Checkbox Group Styling */
  .radio-group { display: flex; gap: 10px; flex-wrap: wrap; }
  
  /* UPDATED: Changed to label for better clicking */
  label.radio-option {
    flex: 1; position: relative; display: block; margin: 0; cursor: pointer;
  }
  .radio-option input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
  .radio-option span {
    display: flex; align-items: center; justify-content: center;
    padding: 10px; border: 2px solid #fed7aa; border-radius: 8px;
    font-weight: 600; font-size: 13px; color: var(--muted);
    transition: all 0.2s; text-align: center; background: white;
  }
  /* Checked States */
  .radio-option input:checked ~ span {
    color: white; 
    box-shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.4);
    transform: translateY(-2px);
  }
  /* Specific colors for status */
  .radio-option input[value="Present"]:checked ~ span { background: var(--secondary); border-color: var(--secondary); }
  .radio-option input[value="Absent"]:checked ~ span { background: var(--danger); border-color: var(--danger); }
  .radio-option input[value="Tardy"]:checked ~ span { background: var(--warning); border-color: var(--warning); }


  /* Show Password Feature */
  .pass-wrapper { position: relative; width: 100%; }
  .pass-wrapper input { padding-right: 40px; }
  .pass-toggle {
    position: absolute; right: 0; top: 0; height: 100%; width: 40px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: var(--muted);
  }

  button { 
    padding: 12px 18px; border-radius: 8px; border: none; cursor: pointer; 
    font-weight: 700; font-size: 14px; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  }
  button.primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(234, 88, 12, 0.3); }
  button.primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
  button.ghost { background: transparent; border: 2px solid #fed7aa; color: var(--primary); }
  button.danger { background: #fee2e2; color: var(--danger); }
  button.danger:hover { background: var(--danger); color: white; }
  
  button:disabled { opacity: 0.6; cursor: not-allowed; }

  /* Grid Layouts */
  .grid { display: grid; grid-template-columns: 1fr 320px; gap: 20px; width: 100%; } 
  @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

  /* Tabs */
  .tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 12px; border-bottom: 2px solid #fed7aa; margin-bottom: 16px; -webkit-overflow-scrolling: touch; } 
  .tabs button { white-space: nowrap; background: transparent; color: var(--muted); border: none; padding: 8px 14px; font-weight: 600; border-radius: 6px; box-shadow: none;} 
  .tabs button.active { background: var(--secondary); color: white; box-shadow: 0 4px 6px rgba(22, 163, 74, 0.3); }

  /* Tables */
  .table-container { 
    overflow-x: auto; -webkit-overflow-scrolling: touch; 
    border-radius: 8px; border: 1px solid #fed7aa; 
    max-width: 100%; background: white;
  }
  table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 600px; } 
  th, td { padding: 12px 16px; border-bottom: 1px solid #fed7aa; text-align: left; }
  th { background: #fff7ed; color: var(--primary); font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; }
  tr:hover { background: #fffbeb; }

  /* Mobile Table View */
  @media (max-width: 600px){
    table, thead, tbody, th, td, tr { display: block; width: 100%; }
    thead { display: none; }
    .table-container { border: none; background: transparent; }
    tr { background: var(--card); margin-bottom: 15px; border: 1px solid #fed7aa; border-radius: 8px; padding: 12px; box-shadow: var(--shadow); }
    td { padding: 10px 0; border: none; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #fed7aa; }
    td:last-child { border-bottom: none; }
    td::before { content: attr(data-label); font-weight: 600; color: var(--muted); font-size: 12px; }
  }

  /* Utility */
  .pill { background: #fff7ed; color: var(--primary); padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 600; border: 1px solid #fed7aa; }
  .hr { height: 1px; background: #fed7aa; margin: 16px 0; width: 100%; }
  .row { display: flex; gap: 12px; flex-wrap: wrap; } 
  .col { flex: 1; min-width: 180px; }

  /* Avatars */
  .avatar-container { text-align: center; }
  .avatar { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 4px solid var(--gold); box-shadow: var(--shadow); background: #fff; }
  .avatar-placeholder { width: 100px; height: 100px; background: #fff7ed; color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 800; border-radius: 50%; margin: 0 auto; border: 4px solid var(--gold); box-shadow: var(--shadow); }
  .thumb { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 10px; border: 2px solid var(--gold); }

  /* Animations */
  .fade-in { animation: fadeIn 0.4s ease forwards; opacity: 0; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .link-btn { background: none; border: none; color: var(--primary); text-decoration: underline; padding: 0; cursor: pointer; font-size: 13px; font-weight: 600; }
  
  #loadingOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 247, 237, 0.9); z-index: 1000;
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; color: var(--primary); font-weight: 700;
  }
</style>
</head>
<body>

<div id="loadingOverlay">
  <div style="font-size: 30px; margin-bottom: 10px;">‚è≥</div>
  <div>Connecting to Database...</div>
</div>

<div class="app">
  <header class="app-header">
    <div class="brand">
      <div class="logo">
        <img src="acshslogo.jpg" alt="AC" style="width:100%; height:100%; object-fit:cover;">
      </div>
      <div><div class="title">Antipolo City SHS</div><div class="subtitle-head">Official Portal (Cloud)</div></div>
    </div>
  </header>

  <main id="loginView" class="center-view fade-in" style="display:none">
    <div class="card" style="max-width: 400px; border-top: 5px solid var(--primary);">
      <h2 style="margin: 0 0 10px 0; text-align: center; color: var(--primary);">Welcome Back</h2>
      <p style="text-align: center; color: var(--muted); font-size: 14px; margin-bottom: 24px;">Sign in to access your grades and schedule</p>

      <label>Role</label>
      <select id="loginRole" style="margin-bottom: 16px;">
        <option value="student">Student</option>
        <option value="admin">Administrator</option>
      </select>

      <label>ID / Username</label>
      <input id="loginId" type="text" placeholder="ID Number" style="margin-bottom: 16px;">

      <label>Password</label>
      <div class="pass-wrapper" style="margin-bottom: 20px;">
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <div class="pass-toggle" onclick="togglePass('loginPass')">üëÅÔ∏è</div>
      </div>

      <button id="btnLogin" class="primary" style="width: 100%;">Sign In</button>
      
      <div style="margin-top: 16px; text-align: center;">
        <button class="link-btn" onclick="showForgotPass()">Forgot Password?</button>
      </div>
      <div style="margin-top: 20px; font-size: 11px; color: var(--muted); text-align: center; border-top:1px dashed #fed7aa; padding-top:10px;">
        Demo Student ID: <b>1202</b> <br> Pass: <b>password</b> <br>
        Admin User: <b>admin</b> | Pass: <b>admin123</b>
      </div>
    </div>
  </main>

  <main id="forgotView" class="center-view fade-in" style="display:none">
    <div class="card" style="max-width: 400px;">
      <h2 style="margin: 0 0 8px 0; text-align: center; color: var(--primary);">Reset Password</h2>
      <p style="text-align: center; color: var(--muted); font-size: 14px; margin-bottom: 24px;">Verify your identity to set a new password</p>

      <label>Student ID</label>
      <input id="recId" type="text" placeholder="e.g. 12-3456" style="margin-bottom: 16px;">

      <label>Slip Number (Verification)</label>
      <input id="recSlip" type="text" placeholder="Check your enrollment slip" style="margin-bottom: 16px;">

      <label>New Password</label>
      <div class="pass-wrapper" style="margin-bottom: 24px;">
        <input id="recNewPass" type="password" placeholder="New Password">
        <div class="pass-toggle" onclick="togglePass('recNewPass')">üëÅÔ∏è</div>
      </div>

      <button class="primary" onclick="processReset()" style="width: 100%;">Save Changes</button>
      <button class="ghost" onclick="showLogin()" style="width: 100%; margin-top:8px">Back to Login</button>
    </div>
  </main>

  <section id="dashboardView" style="display:none" class="fade-in">
    <div class="grid">
      <div style="min-width: 0;"> 
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
            <div>
              <div id="userTitle" style="font-weight:800; font-size:24px; color: var(--primary);">...</div>
              <div id="userMeta" class="subtitle" style="font-weight: 500;">...</div>
            </div>
            <button class="danger ghost" onclick="logout()" style="border: 1px solid #fee2e2;">Logout</button>
          </div>

          <div id="tabsArea" class="tabs"></div>
          <div id="mainArea" class="fade-in"></div>
        </div>
      </div>

      <aside>
        <div class="card" style="background: var(--bg-1);">
          <div class="subtitle" style="text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; color: var(--primary);">Dashboard Stats</div>
          <div style="font-weight:700; font-size: 18px; margin: 8px 0; color: var(--text);" id="todayDate"></div>
          <div class="hr"></div>
          <div id="quickPills" style="display:flex; gap:8px; flex-wrap:wrap"></div>
          <div style="margin-top:16px; font-size: 13px; line-height: 1.5;" id="rightShort"></div>
        </div>
      </aside>
    </div>
  </section>
</div>

<script type="module">
  // --- 1. FIREBASE CONFIGURATION ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, where, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // !!! PASTE YOUR FIREBASE CONFIG HERE !!!
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBCfLqkBmvZdJBtG4es-jOBsxxz3lFsMko",
  authDomain: "my-acshs.firebaseapp.com",
  projectId: "my-acshs",
  storageBucket: "my-acshs.firebasestorage.app",
  messagingSenderId: "675499168616",
  appId: "1:675499168616:web:14dc5bbe619616fbe5fcdd",
  measurementId: "G-MJTT5Q9GF2"
};

  // --- 2. INIT FIREBASE ---
  let db;
  try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    console.log("Firebase Connected");
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('loginView').style.display = 'flex';
  } catch(e) {
    console.error("Firebase Error", e);
    document.querySelector('#loadingOverlay div:last-child').innerHTML = "Error: Check Firebase Config in code.";
  }

  // --- Constants ---
  const ADMIN = { username:'admin', password:'admin123' };
  const SECTIONS = ['ICT-1201', 'ICT-1202', 'ICT-1203'];
  const SUBJECTS = ['M.I.L', 'JAVA', 'P.E', 'TRIPLE III', 'WORK IMMERSION'];

  // --- Global State ---
  let state = { role: null, user: null };
  // We keep local copies for fast rendering after fetch
  let dbUsers = [];
  let dbAtt = [];
  let dbGrades = [];
  let dbSched = [];

  // --- 3. HELPER FUNCTIONS (Async) ---
  
  // Fetch all documents from a collection and return array with IDs
  async function fetchCollection(colName) {
    const q = query(collection(db, colName));
    const snap = await getDocs(q);
    const list = [];
    snap.forEach(doc => {
      list.push({ docId: doc.id, ...doc.data() });
    });
    return list;
  }

  // Add Data
  async function addData(colName, data) {
    try {
      await addDoc(collection(db, colName), data);
      alert('Saved successfully!');
      return true;
    } catch(e) { console.error(e); alert('Error saving.'); return false; }
  }

  // Delete Data
  async function removeData(colName, docId) {
    try {
      await deleteDoc(doc(db, colName, docId));
      return true;
    } catch(e) { console.error(e); alert('Error deleting.'); return false; }
  }

  // Helper to format date
  function getMMDD(date){ if(!date) return ''; const p=date.split('-'); return p.length===3 ? p[1]+p[2] : ''; }

  /* --- 4. AUTH & UI LOGIC --- */

  window.togglePass = (id) => {
    const el = document.getElementById(id);
    el.type = el.type === 'password' ? 'text' : 'password';
  }

  window.showForgotPass = () => { document.getElementById('loginView').style.display='none'; document.getElementById('forgotView').style.display='flex'; }
  window.showLogin = () => { document.getElementById('forgotView').style.display='none'; document.getElementById('loginView').style.display='flex'; }

  // Login Button Logic
  document.getElementById('btnLogin').addEventListener('click', async () => {
    const role = document.getElementById('loginRole').value;
    const id = document.getElementById('loginId').value.trim();
    const pass = document.getElementById('loginPass').value.trim();
    const btn = document.getElementById('btnLogin');

    if(!id || !pass) return alert("Enter credentials");

    btn.innerText = "Verifying...";
    btn.disabled = true;

    if(role === 'admin'){
      if(id === ADMIN.username && pass === ADMIN.password){
        state.role = 'admin';
        state.user = { username: 'Admin' };
        await openDashboard();
      } else { alert('Incorrect Admin password.'); }
    } else {
      // Fetch user from Firestore
      const q = query(collection(db, "users"), where("id", "==", id));
      const querySnapshot = await getDocs(q);
      
      if(querySnapshot.empty) {
        alert('Student ID not found.');
      } else {
        const uDoc = querySnapshot.docs[0];
        const uData = uDoc.data();
        uData.docId = uDoc.id; // Store firestore ID

        const defaultPass = `${uData.id}-${getMMDD(uData.birth)}`;
        const validPass = uData.password || defaultPass;

        if(pass === validPass){
          state.role = 'student';
          state.user = uData;
          await openDashboard();
        } else {
          alert('Wrong password.');
        }
      }
    }
    btn.innerText = "Sign In";
    btn.disabled = false;
  });

  window.logout = () => { location.reload(); }

  // Forgot Password
  window.processReset = async () => {
    const id = document.getElementById('recId').value.trim();
    const slip = document.getElementById('recSlip').value.trim();
    const newPass = document.getElementById('recNewPass').value.trim();

    if(!id || !slip || !newPass) return alert("Fill all fields");

    // Find user
    const q = query(collection(db, "users"), where("id", "==", id), where("slipNumber", "==", slip));
    const snap = await getDocs(q);

    if(!snap.empty){
      const uDoc = snap.docs[0];
      await updateDoc(doc(db, "users", uDoc.id), { password: newPass });
      alert('Password updated! Please login.');
      showLogin();
    } else {
      alert('Invalid ID or Slip Number.');
    }
  }

  /* --- 5. DASHBOARD --- */

  async function openDashboard(){
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('dashboardView').style.display = 'block';
    document.getElementById('todayDate').innerText = new Date().toDateString();

    // Load data based on role
    if(state.role === 'admin'){
      document.getElementById('userTitle').innerText = 'Administrator';
      document.getElementById('userMeta').innerText = 'System Management';
      await refreshAllAdminData();
      buildAdminTabs();
    } else {
      document.getElementById('userTitle').innerText = `${state.user.firstName} ${state.user.lastName}`;
      document.getElementById('userMeta').innerText = `ID: ${state.user.id} | ${state.user.section}`;
      await refreshStudentData();
      buildStudentTabs();
    }
    updateSidebar();
  }

  async function refreshAllAdminData() {
    // Parallel fetch for speed
    const [u, a, g, s] = await Promise.all([
      fetchCollection('users'),
      fetchCollection('attendance'),
      fetchCollection('grades'),
      fetchCollection('schedule')
    ]);
    dbUsers = u; dbAtt = a; dbGrades = g; dbSched = s;
  }

  async function refreshStudentData() {
    // Students need schedule, their grades, their attendance
    const [a, g, s] = await Promise.all([
      fetchCollection('attendance'),
      fetchCollection('grades'),
      fetchCollection('schedule')
    ]);
    dbAtt = a; dbGrades = g; dbSched = s;
  }

  function updateSidebar(){
    const pills = document.getElementById('quickPills');
    const short = document.getElementById('rightShort');
    pills.innerHTML = '';
    
    if(state.role === 'admin'){
      pills.innerHTML = `<div class="pill">${dbUsers.length} Students Enrolled</div>`;
      short.innerText = "Manage students, grades, and attendance from the tabs above. Data is saved to Cloud.";
    } else {
      const absences = dbAtt.filter(a => a.userId === state.user.id && a.status === 'Absent').length;
      const lates = dbAtt.filter(a => a.userId === state.user.id && a.status === 'Tardy').length;
      pills.innerHTML = `
        <div class="pill" style="color:white; background:${absences>0?'var(--danger)':'var(--success)'}">${absences} Absences</div>
        <div class="pill" style="color:white; background:${lates>0?'var(--warning)':'var(--muted)'}">${lates} Lates</div>
      `;
      short.innerText = "Keep your Slip Number private. It is used for account recovery.";
    }
  }

  // --- Tabs Logic ---
  const tabsArea = document.getElementById('tabsArea');
  const mainArea = document.getElementById('mainArea');

  function buildAdminTabs(){
    tabsArea.innerHTML = '';
    const list = [
      { n: 'Students', f: renderManageStudents },
      { n: 'Attendance', f: renderAdminAttendance },
      { n: 'Grades', f: renderAdminGrades },
      { n: 'Schedule', f: renderAdminSchedule }
    ];
    list.forEach((t, i) => addTabBtn(t.n, i===0, t.f));
  }

  function buildStudentTabs(){
    tabsArea.innerHTML = '';
    const list = [
      { n: 'Profile', f: renderStudentProfile },
      { n: 'Schedule', f: renderStudentSchedule },
      { n: 'Attendance', f: renderStudentAttendance },
      { n: 'Grades', f: renderStudentGrades }
    ];
    list.forEach((t, i) => addTabBtn(t.n, i===0, t.f));
  }

  function addTabBtn(name, active, func){
    const b = document.createElement('button');
    b.innerText = name;
    if(active) { b.classList.add('active'); func(); }
    b.onclick = () => {
      Array.from(tabsArea.children).forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      mainArea.innerHTML = '<div style="padding:20px; text-align:center">Loading data...</div>';
      func();
    };
    tabsArea.appendChild(b);
  }

  /* ================= ADMIN RENDER FUNCTIONS ================= */

  window.renderManageStudents = () => {
    const rows = dbUsers.map((u) => `
      <tr>
        <td data-label="Student">
          <div style="display:flex; align-items:center;">
            ${u.avatar ? `<img src="${u.avatar}" class="thumb">` : '<div class="thumb" style="background:#ddd"></div>'}
            <strong>${u.id}</strong>
          </div>
        </td>
        <td data-label="Name">${u.firstName} ${u.lastName}</td>
        <td data-label="Section"><span class="pill">${u.section || 'N/A'}</span></td>
        <td data-label="Actions">
          <button class="ghost" onclick="uploadPhoto('${u.docId}')" style="padding:4px 8px; font-size:11px">Photo</button>
          <button class="danger" onclick="delStudent('${u.docId}')" style="padding:4px 8px; font-size:11px">Del</button>
        </td>
      </tr>`).join('');

    mainArea.innerHTML = `
      <div class="fade-in">
        <h3 style="color:var(--primary)">Student Management (Firebase)</h3>
        <div class="card" style="background:var(--bg-2); border:none; margin-bottom:20px;">
          <div class="row">
            <div class="col"><label>ID Number</label><input id="ni" placeholder="12-0001"></div>
            <div class="col"><label>Slip Number</label><input id="ns" placeholder="A100-XYZ"></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col"><label>First Name</label><input id="nf"></div>
            <div class="col"><label>Last Name</label><input id="nl"></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col">
              <label>Section</label>
              <select id="nSec">
                <option value="" disabled selected>Select Section</option>
                ${SECTIONS.map(s => `<option value="${s}">${s}</option>`).join('')}
              </select>
            </div>
            <div class="col"><label>Birth Date</label><input id="nb" type="date"></div>
          </div>
          <button class="primary" onclick="doAddStudent()" style="width:100%; margin-top:15px">Register Student</button>
        </div>
        <div class="table-container">
          <table><thead><tr><th>ID</th><th>Name</th><th>Section</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>
        </div>
      </div>`;
  }

  window.doAddStudent = async () => {
    const id=document.getElementById('ni').value, slip=document.getElementById('ns').value, f=document.getElementById('nf').value, l=document.getElementById('nl').value, sec=document.getElementById('nSec').value, b=document.getElementById('nb').value;
    if(!id||!slip||!f||!l||!b||!sec) return alert('Fill all fields');
    
    // Check for duplicate ID locally before sending
    if(dbUsers.find(u => u.id === id)) return alert('Student ID already exists.');

    const success = await addData('users', { id, slipNumber:slip, firstName:f, lastName:l, section:sec, birth:b, avatar:null });
    if(success) {
      dbUsers = await fetchCollection('users'); // Refresh
      renderManageStudents(); updateSidebar();
    }
  }

  window.delStudent = async (docId) => { 
    if(confirm('Delete student?')){ 
      await removeData('users', docId);
      dbUsers = await fetchCollection('users');
      renderManageStudents(); updateSidebar(); 
    } 
  }

  window.uploadPhoto = (docId) => {
    const el = document.createElement('input'); el.type='file'; el.accept='image/*';
    el.onchange = e => {
      const reader = new FileReader();
      reader.onload = async ev => {
        const base64 = ev.target.result;
        // Update Firestore
        try {
          await updateDoc(doc(db, 'users', docId), { avatar: base64 });
          dbUsers = await fetchCollection('users');
          renderManageStudents();
        } catch(err) { alert('Image too big or upload error.'); }
      };
      reader.readAsDataURL(e.target.files[0]);
    };
    el.click();
  }

  /* --- Admin Attendance --- */
  window.renderAdminAttendance = () => {
    // Reverse logs to show newest first
    const rows = dbAtt.slice().reverse().map((l) => {
      return `<tr><td data-label="ID">${l.userId}</td><td data-label="Date">${l.date}</td><td data-label="Status"><span class="pill" style="${getStatusStyle(l.status)}">${l.status}</span></td><td data-label="Action"><button class="danger" onclick="delAtt('${l.docId}')" style="padding:4px">X</button></td></tr>`
    }).join('');
    
    mainArea.innerHTML = `
      <div class="fade-in">
        <h3 style="color:var(--primary)">Attendance Log</h3>
        <div class="card" style="background:var(--bg-2); border:none; margin-bottom:20px;">
          <div class="row">
            <div class="col">
              <label>Student</label>
              <select id="au">${dbUsers.map(u=>`<option value="${u.id}">${u.id} - ${u.lastName}</option>`).join('')}</select>
            </div>
            <div class="col"><label>Date</label><input type="date" id="ad" value="${new Date().toISOString().split('T')[0]}"></div>
          </div>
          
          <label style="margin-top:10px">Status</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="attStatus" value="Present" checked>
              <span>Present</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="attStatus" value="Absent">
              <span>Absent</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="attStatus" value="Tardy">
              <span>Tardy</span>
            </label>
          </div>
  
          <button class="primary" onclick="doAddAtt()" style="width:100%; margin-top:15px">Record Attendance</button>
        </div>
        <div class="table-container"><table><thead><tr><th>ID</th><th>Date</th><th>Status</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>
      </div>`;
  }
  function getStatusStyle(s){
    if(s==='Absent') return 'background:#fee2e2; color:var(--danger)';
    if(s==='Tardy') return 'background:#fef3c7; color:var(--warning)';
    return 'background:#dcfce7; color:var(--success)';
  }
  window.doAddAtt = async () => { 
    const status = document.querySelector('input[name="attStatus"]:checked').value;
    const userId = document.getElementById('au').value;
    const date = document.getElementById('ad').value;
    await addData('attendance', {userId, date, status}); 
    dbAtt = await fetchCollection('attendance');
    renderAdminAttendance(); 
  }
  window.delAtt = async (docId) => { await removeData('attendance', docId); dbAtt = await fetchCollection('attendance'); renderAdminAttendance(); }

  /* --- Admin Grades --- */
  window.renderAdminGrades = () => {
    const rows = dbGrades.map((g) => `<tr><td data-label="ID">${g.userId}</td><td data-label="Subject">${g.subject}</td><td data-label="Grade"><strong style="color:var(--primary); font-size:16px">${g.grade}</strong></td><td data-label="Action"><button class="danger" onclick="delGrd('${g.docId}')" style="padding:4px">X</button></td></tr>`).join('');
    
    mainArea.innerHTML = `
      <div class="fade-in">
        <h3 style="color:var(--primary)">Grading Sheet</h3>
        <div class="card" style="background:var(--bg-2); border:none; margin-bottom:20px;">
          <div class="row">
            <div class="col">
              <label>Student</label>
              <select id="gu">${dbUsers.map(u=>`<option value="${u.id}">${u.lastName}, ${u.firstName} (${u.section})</option>`).join('')}</select>
            </div>
            <div class="col">
              <label>Subject</label>
              <select id="gs">
                ${SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('')}
              </select>
            </div>
            <div class="col"><label>Grade</label><input id="gv" type="number" placeholder="e.g. 95"></div>
          </div>
          <button class="primary" onclick="doAddGrd()" style="width:100%; margin-top:15px">Submit Grade</button>
        </div>
        <div class="table-container"><table><thead><tr><th>ID</th><th>Subject</th><th>Grade</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>
      </div>`;
  }
  window.doAddGrd = async () => { 
    await addData('grades', {userId:document.getElementById('gu').value, subject:document.getElementById('gs').value, grade:document.getElementById('gv').value});
    dbGrades = await fetchCollection('grades');
    renderAdminGrades(); 
  }
  window.delGrd = async (docId) => { await removeData('grades', docId); dbGrades = await fetchCollection('grades'); renderAdminGrades(); }

  /* --- Admin Schedule --- */
  window.renderAdminSchedule = () => {
    const rows = dbSched.map((s) => `<tr><td data-label="Subj">${s.subject}</td><td data-label="Time">${s.time}</td><td data-label="Room">${s.room}</td><td data-label="Action"><button class="danger" onclick="delSch('${s.docId}')" style="padding:4px">X</button></td></tr>`).join('');
    mainArea.innerHTML = `
      <div class="fade-in">
        <h3 style="color:var(--primary)">Class Schedule</h3>
        <div class="card" style="background:var(--bg-2); border:none; margin-bottom:20px;">
          <div class="row">
            <div class="col"><label>Subject</label><input id="ss" placeholder="Subject Name"></div>
            <div class="col"><label>Time</label><input id="st" placeholder="e.g. Mon 8-9AM"></div>
            <div class="col"><label>Teacher/Room</label><input id="sr" placeholder="Room"></div>
          </div>
          <button class="primary" onclick="doAddSch()" style="width:100%; margin-top:15px">Add to Schedule</button>
        </div>
        <div class="table-container"><table><thead><tr><th>Subject</th><th>Time</th><th>Room</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>
      </div>`;
  }
  window.doAddSch = async () => { 
    await addData('schedule', {subject:document.getElementById('ss').value, time:document.getElementById('st').value, room:document.getElementById('sr').value}); 
    dbSched = await fetchCollection('schedule');
    renderAdminSchedule(); 
  }
  window.delSch = async (docId) => { await removeData('schedule', docId); dbSched = await fetchCollection('schedule'); renderAdminSchedule(); }

  /* ================= STUDENT FUNCTIONS ================= */

  window.renderStudentProfile = () => {
    const u = state.user;
    mainArea.innerHTML = `
      <div class="fade-in">
        <div class="avatar-container">
          ${u.avatar ? `<img src="${u.avatar}" class="avatar">` : `<div class="avatar-placeholder">${u.firstName[0]}</div>`}
          <h2 style="margin:10px 0 2px 0; color: var(--primary);">${u.firstName} ${u.lastName}</h2>
          <div class="subtitle">${u.id} | ${u.section}</div>
        </div>
        <div class="hr"></div>
        <div class="row">
          <div class="col"><label>Birthday</label><div>${u.birth}</div></div>
          <div class="col"><label>Status</label><div style="color:var(--secondary); font-weight:700">ENROLLED</div></div>
        </div>
      </div>`;
  }

  window.renderStudentSchedule = () => {
    const rows = dbSched.map(s => `<tr><td data-label="Subject"><b>${s.subject}</b></td><td data-label="Time/Day">${s.time}</td><td data-label="Teacher">${s.room}</td></tr>`).join('');
    mainArea.innerHTML = `<h3 style="color:var(--primary)">My Schedule</h3><div class="table-container"><table><thead><tr><th>Subject</th><th>Time / Day</th><th>Teacher</th></tr></thead><tbody>${rows||'<tr><td colspan="3">No schedule posted.</td></tr>'}</tbody></table></div>`;
  }

  window.renderStudentAttendance = () => {
    const rows = dbAtt.filter(a=>a.userId===state.user.id).map(a => `<tr><td data-label="Date">${a.date}</td><td data-label="Status"><span class="pill" style="${getStatusStyle(a.status)}">${a.status}</span></td></tr>`).join('');
    mainArea.innerHTML = `<h3 style="color:var(--primary)">My Attendance</h3><div class="table-container"><table><thead><tr><th>Date</th><th>Status</th></tr></thead><tbody>${rows||'<tr><td colspan="2">No records found.</td></tr>'}</tbody></table></div>`;
  }

  window.renderStudentGrades = () => {
    const rows = dbGrades.filter(g=>g.userId===state.user.id).map(g => `<tr><td data-label="Subject"><b>${g.subject}</b></td><td data-label="Grade" style="font-size:16px; color:var(--primary)"><b>${g.grade}</b></td></tr>`).join('');
    mainArea.innerHTML = `<h3 style="color:var(--primary)">Report Card</h3><div class="table-container"><table><thead><tr><th>Subject</th><th>Grade</th></tr></thead><tbody>${rows||'<tr><td colspan="2">Grades not yet released.</td></tr>'}</tbody></table></div>`;
  }

</script>
</body>
</html>
